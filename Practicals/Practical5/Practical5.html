<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Practical 5 - Spatio-temporal model for ozone concentrations in New York</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Practical5_files/libs/clipboard/clipboard.min.js"></script>
<script src="Practical5_files/libs/quarto-html/quarto.js"></script>
<script src="Practical5_files/libs/quarto-html/popper.min.js"></script>
<script src="Practical5_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Practical5_files/libs/quarto-html/anchor.min.js"></script>
<link href="Practical5_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Practical5_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Practical5_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Practical5_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Practical5_files/libs/bootstrap/bootstrap-48d078b43f8372132f50074d7c21a68c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="Practical5_files/libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">

<script src="Practical5_files/libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>

<script src="Practical5_files/libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>

<link href="Practical5_files/libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">

<script src="Practical5_files/libs/leaflet-1.3.1/leaflet.js"></script>

<link href="Practical5_files/libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">

<script src="Practical5_files/libs/proj4-2.6.2/proj4.min.js"></script>

<script src="Practical5_files/libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>

<link href="Practical5_files/libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">

<script src="Practical5_files/libs/leaflet-binding-2.2.2/leaflet.js"></script>

<script src="Practical5_files/libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js"></script>

<script src="Practical5_files/libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js"></script>

<script src="Practical5_files/libs/HomeButton-0.0.1/home-button.js"></script>

<script src="Practical5_files/libs/HomeButton-0.0.1/easy-button-src.min.js"></script>

<link href="Practical5_files/libs/data-CSS-0.0.1/data_home-button.css" rel="stylesheet">

<script src="Practical5_files/libs/clipboard-0.0.1/setClipboardText.js"></script>

<link href="Practical5_files/libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet">

<link href="Practical5_files/libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet">


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#new-york-air-pollution-data-set" id="toc-new-york-air-pollution-data-set" class="nav-link" data-scroll-target="#new-york-air-pollution-data-set">New York air pollution data set</a></li>
  <li><a href="#spatio-temporal-model" id="toc-spatio-temporal-model" class="nav-link" data-scroll-target="#spatio-temporal-model">Spatio-temporal model</a></li>
  <li><a href="#cross-validation" id="toc-cross-validation" class="nav-link" data-scroll-target="#cross-validation">Cross-validation</a>
  <ul class="collapse">
  <li><a href="#prediction-at-the-hold-out-validation-sites-k-fold-cross-validation" id="toc-prediction-at-the-hold-out-validation-sites-k-fold-cross-validation" class="nav-link" data-scroll-target="#prediction-at-the-hold-out-validation-sites-k-fold-cross-validation">Prediction at the hold-out validation sites: k-fold cross-validation</a></li>
  </ul></li>
  <li><a href="#exercise" id="toc-exercise" class="nav-link" data-scroll-target="#exercise">Exercise</a></li>
  <li><a href="#run-the-model-on-the-entire-data-set-to-obtain-predictions-for-ozone-on-the-grid" id="toc-run-the-model-on-the-entire-data-set-to-obtain-predictions-for-ozone-on-the-grid" class="nav-link" data-scroll-target="#run-the-model-on-the-entire-data-set-to-obtain-predictions-for-ozone-on-the-grid">Run the model on the entire data set to obtain predictions for ozone on the grid</a>
  <ul class="collapse">
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Practical 5 - Spatio-temporal model for ozone concentrations in New York</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In this practical we use a dataset that comprises daily maximum 8-hour average ground level ozone (<span class="math inline">\(O_3\)</span>, ppb) concentrations for the period July 1 and August 31 in 2006 (62 days), measured at 28 monitoring sites in the state of New York, USA.</p>
<p>The stations are part of the Environmental Protection Agency (EPA) monitoring network.</p>
<p>Ozone occurs naturally in the upper atmosphere and protects the Earth from the sun’s rays. However, at ground level it can be harmful for population health, as it can lead to adverse respiratory effects. Ozone is most likely to reach worrisome levels on hot sunny days in urban environments (even if it can still reach high levels during colder months).</p>
<p>In this practical we use R software, and we rely on advanced methods based on the Integrated Nested Laplace Approximation (INLA) combined with the Stochastic Partial Differential Equation (SPDE) approach for Bayesian computation.</p>
<p>The dataset used for this practical is included in the R package <code>spTimer</code>. The data available are as follows:</p>
<ul>
<li><code>s.index</code>: index of the monitoring station in the NY state</li>
</ul>
<!-- -->
<ul>
<li><code>Longitude</code> and <code>Latitude</code>: spatial coordinates of the monitoring stations</li>
</ul>
<!-- -->
<ul>
<li><code>utmx</code> and <code>utmy</code>: spatial UTM X and UTM Y coordinate of the monitoring stations</li>
</ul>
<!-- -->
<ul>
<li><code>Year</code>, <code>Month</code> and <code>Day</code>; temporal coordinates of the measurements</li>
</ul>
<!-- -->
<ul>
<li><p><code>y8hrmax</code>: daily 8-hour maximum average ozone concentrations (parts per billion)</p></li>
<li><p><code>xmaxtemp</code> : daily maximum temperature (in degree Celsius)</p></li>
<li><p><code>xwdsp</code>: wind speed (knots),</p></li>
<li><p><code>xrh</code>: relative humidity</p></li>
</ul>
<p>Of the 1,736 possible observations, i.e., n=28 locations times T=62 daily `o8hrmax` measurements, 24 are missing.</p>
<p>We use <code>y8hrmax</code> concentrations as outcome (i.e.&nbsp;response variable) and <code>xmaxtemp</code>, <code>xwdsp</code> and <code>xrh</code> as predictors. The data frame is named <code>nysptime</code> and is included in the Workspace <code>DataNY.RData</code>. It includes also the grid that will be used to obtain and map the predictions <code>gridnysptime</code>.</p>
<p>For computational reasons in this lab we will work with a subset of the data.</p>
<p>The following packages are required:</p>
<p>Summary of functions to manipulate marginal distribution in the <code>INLA</code> package</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mapview) </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvtsplot)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(INLA)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(inlabru)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sp)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fmesher)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GGally)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="new-york-air-pollution-data-set" class="level2">
<h2 class="anchored" data-anchor-id="new-york-air-pollution-data-set">New York air pollution data set</h2>
<p>The data are obtained from 28 monitoring sites, between July 1 and August 31 in 2006.</p>
<ul>
<li>Load the data</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"DataNY.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>We create a map of the monitoring station using <code>mapview</code> package. Here we plot the longitude and latitude using the World Geographic System 1984 (WGS84) projection, which is referenced as European Petroleum Survey Group (EPSG) 4326.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>stations <span class="ot">=</span> <span class="fu">cbind</span>(<span class="fu">unique</span>(nysptime[,<span class="dv">1</span>]), <span class="fu">unique</span>(nysptime[,<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>]))</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># set the map projection to a common projection standard such as WGS84 via the argument crs = 4326</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mapview</span>(stations, <span class="at">xcol =</span> <span class="st">"Longitude"</span>, <span class="at">ycol =</span> <span class="st">"Latitude"</span>, </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">crs =</span> <span class="dv">4326</span>, <span class="at">grid =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="leaflet html-widget html-fill-item" id="htmlwidget-80b5687c6727492ba3ce" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-80b5687c6727492ba3ce">{"x":{"options":{"minZoom":1,"maxZoom":52,"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"preferCanvas":false,"bounceAtZoomLimits":false,"maxBounds":[[[-90,-370]],[[90,370]]]},"calls":[{"method":"addProviderTiles","args":["CartoDB.Positron","CartoDB.Positron","CartoDB.Positron",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["CartoDB.DarkMatter","CartoDB.DarkMatter","CartoDB.DarkMatter",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenStreetMap","OpenStreetMap","OpenStreetMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["Esri.WorldImagery","Esri.WorldImagery","Esri.WorldImagery",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenTopoMap","OpenTopoMap","OpenTopoMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"createMapPane","args":["point",440]},{"method":"addCircleMarkers","args":[[42.681,40.866,42.291,42.111,41.782,42.993,44.366,44.393,43.45,43.686,44.087,42.73,43.224,43.052,41.524,41.442,43.012,42.8,40.746,40.961,42.144,43.231,41.052,42.401,40.816,43.3,40.827,40.736],[-73.75700000000001,-73.881,-79.587,-76.80200000000001,-73.74299999999999,-78.771,-73.90300000000001,-73.85899999999999,-74.51600000000001,-74.985,-75.973,-75.78400000000001,-78.479,-76.059,-74.215,-73.708,-73.649,-73.94,-73.419,-72.71299999999999,-74.494,-77.17400000000001,-73.764,-76.654,-73.902,-75.71899999999999,-73.057,-73.82299999999999],6,null,"data",{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"pane":"point","stroke":true,"color":"#333333","weight":1,"opacity":0.9,"fill":true,"fillColor":"#6666FF","fillOpacity":0.6},null,null,["<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>1&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-73.757&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>42.681&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>683&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>2&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-73.881&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>40.866&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1303&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>3&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-79.587&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>42.291&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1365&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>4&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-76.802&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>42.111&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1427&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>5&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-73.743&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>41.782&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1489&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>6&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-78.771&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>42.993&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1551&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>7&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-73.903&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>44.366&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1613&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>8&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-73.859&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>44.393&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1675&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>9&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-74.516&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>43.45&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>63&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>10&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-74.985&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>43.686&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>125&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>11&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-75.973&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>44.087&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>187&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>12&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-75.784&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>42.73&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>249&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>13&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-78.479&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>43.224&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>311&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>14&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-76.059&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>43.052&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>373&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>15&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-74.215&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>41.524&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>435&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>16&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-73.708&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>41.442&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>497&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>17&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-73.649&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>43.012&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>559&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>18&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-73.94&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>42.8&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>621&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>19&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-73.419&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>40.746&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>745&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>20&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-72.713&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>40.961&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>807&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>21&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-74.494&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>42.144&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>869&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>22&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-77.174&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>43.231&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>931&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>23&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-73.764&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>41.052&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>993&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>24&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-76.654&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>42.401&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1055&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>25&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-73.902&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>40.816&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1117&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>26&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-75.719&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>43.3&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1179&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>27&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-73.057&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>40.827&emsp;<\/td><\/tr><\/table><\/div>","<div class='scrollableContainer'><table class=mapview-popup id='popup'><tr class='coord'><td><\/td><th><b>Feature ID&emsp;<\/b><\/th><td>1241&emsp;<\/td><\/tr><tr><td>1<\/td><th>unique(nysptime[, 1])&emsp;<\/th><td>28&emsp;<\/td><\/tr><tr><td>2<\/td><th>Longitude&emsp;<\/th><td>-73.823&emsp;<\/td><\/tr><tr><td>3<\/td><th>Latitude&emsp;<\/th><td>40.736&emsp;<\/td><\/tr><\/table><\/div>"],{"maxWidth":800,"minWidth":50,"autoPan":true,"keepInView":false,"closeButton":true,"closeOnClick":true,"className":""},["Longitude (x) : -73.757<br>Latitude (y) : 42.681","Longitude (x) : -73.881<br>Latitude (y) : 40.866","Longitude (x) : -79.587<br>Latitude (y) : 42.291","Longitude (x) : -76.802<br>Latitude (y) : 42.111","Longitude (x) : -73.743<br>Latitude (y) : 41.782","Longitude (x) : -78.771<br>Latitude (y) : 42.993","Longitude (x) : -73.903<br>Latitude (y) : 44.366","Longitude (x) : -73.859<br>Latitude (y) : 44.393","Longitude (x) : -74.516<br>Latitude (y) : 43.45","Longitude (x) : -74.985<br>Latitude (y) : 43.686","Longitude (x) : -75.973<br>Latitude (y) : 44.087","Longitude (x) : -75.784<br>Latitude (y) : 42.73","Longitude (x) : -78.479<br>Latitude (y) : 43.224","Longitude (x) : -76.059<br>Latitude (y) : 43.052","Longitude (x) : -74.215<br>Latitude (y) : 41.524","Longitude (x) : -73.708<br>Latitude (y) : 41.442","Longitude (x) : -73.649<br>Latitude (y) : 43.012","Longitude (x) : -73.94<br>Latitude (y) : 42.8","Longitude (x) : -73.419<br>Latitude (y) : 40.746","Longitude (x) : -72.713<br>Latitude (y) : 40.961","Longitude (x) : -74.494<br>Latitude (y) : 42.144","Longitude (x) : -77.174<br>Latitude (y) : 43.231","Longitude (x) : -73.764<br>Latitude (y) : 41.052","Longitude (x) : -76.654<br>Latitude (y) : 42.401","Longitude (x) : -73.902<br>Latitude (y) : 40.816","Longitude (x) : -75.719<br>Latitude (y) : 43.3","Longitude (x) : -73.057<br>Latitude (y) : 40.827","Longitude (x) : -73.823<br>Latitude (y) : 40.736"],{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addScaleBar","args":[{"maxWidth":100,"metric":true,"imperial":true,"updateWhenIdle":true,"position":"bottomleft"}]},{"method":"addHomeButton","args":[-79.587,40.736,-72.71299999999999,44.393,true,"data","Zoom to data","<strong> data <\/strong>","bottomright"]},{"method":"addLayersControl","args":[["CartoDB.Positron","CartoDB.DarkMatter","OpenStreetMap","Esri.WorldImagery","OpenTopoMap"],"data",{"collapsed":true,"autoZIndex":true,"position":"topleft"}]},{"method":"addLegend","args":[{"colors":["#6666FF"],"labels":["data"],"na_color":null,"na_label":"NA","opacity":1,"position":"topright","type":"factor","title":"","extra":null,"layerId":null,"className":"info legend","group":"data"}]}],"limits":{"lat":[40.736,44.393],"lng":[-79.587,-72.71299999999999]},"fitBounds":[40.736,-79.587,44.393,-72.71299999999999,[]]},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (\n      function(el, x, data) {\n      // get the leaflet map\n      var map = this; //HTMLWidgets.find('#' + el.id);\n      // we need a new div element because we have to handle\n      // the mouseover output separately\n      // debugger;\n      function addElement () {\n      // generate new div Element\n      var newDiv = $(document.createElement('div'));\n      // append at end of leaflet htmlwidget container\n      $(el).append(newDiv);\n      //provide ID and style\n      newDiv.addClass('lnlt');\n      newDiv.css({\"position\":\"relative\",\"bottomleft\":\"0px\",\"background-color\":\"rgba(255, 255, 255, 0.7)\",\"box-shadow\":\"0 0 2px #bbb\",\"background-clip\":\"padding-box\",\"margin\":\"0\",\"padding-left\":\"5px\",\"padding-right\":\"5px\",\"color\":\"#333\",\"font-size\":\"9px\",\"font-family\":\"\\\"Helvetica Neue\\\", Arial, Helvetica, sans-serif\",\"text-align\":\"left\",\"z-index\":\"700\"});\n      return newDiv;\n      }\n\n\n      // check for already existing lnlt class to not duplicate\n      var lnlt = $(el).find('.lnlt');\n\n      if(!lnlt.length) {\n      lnlt = addElement();\n\n      // grab the special div we generated in the beginning\n      // and put the mousmove output there\n\n      map.on('mousemove', function (e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                           ' | zoom: ' + map.getZoom() +\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\n                           ' | epsg: 3857 ' +\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\n      } else {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      }\n      });\n\n      // remove the lnlt div when mouse leaves map\n      map.on('mouseout', function (e) {\n      var strip = document.querySelector('.lnlt');\n      if( strip !==null) strip.remove();\n      });\n\n      };\n\n      //$(el).keypress(67, function(e) {\n      map.on('preclick', function(e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      var txt = document.querySelector('.lnlt').textContent;\n      console.log(txt);\n      //txt.innerText.focus();\n      //txt.select();\n      setClipboardText('\"' + txt + '\"');\n      }\n      });\n\n      }\n      ).call(this.getMap(), el, x, data);\n}","data":null},{"code":"function(el, x, data) {\n  return (function(el,x,data){\n           var map = this;\n\n           map.on('keypress', function(e) {\n               console.log(e.originalEvent.code);\n               var key = e.originalEvent.code;\n               if (key === 'KeyE') {\n                   var bb = this.getBounds();\n                   var txt = JSON.stringify(bb);\n                   console.log(txt);\n\n                   setClipboardText('\\'' + txt + '\\'');\n               }\n           })\n        }).call(this.getMap(), el, x, data);\n}","data":null}]}}</script>
</div>
</div>
<ul>
<li><p>We create a variable <code>date</code> using the package <code>lubridate</code> joining together the information about the year, the month and the day.</p></li>
<li><p>We also use the function <code>glimpse()</code> from the R package <code>dplyr</code> to see every column in a data frame.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>nysptime <span class="ot">=</span> nysptime <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">make_date</span>(Year, Month, Day))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(nysptime)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 1,736
Columns: 13
$ s.index   &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ Longitude &lt;dbl&gt; -73.757, -73.757, -73.757, -73.757, -73.757, -73.757, -73.75…
$ Latitude  &lt;dbl&gt; 42.681, 42.681, 42.681, 42.681, 42.681, 42.681, 42.681, 42.6…
$ utmx      &lt;dbl&gt; 601838.1, 601838.1, 601838.1, 601838.1, 601838.1, 601838.1, …
$ utmy      &lt;dbl&gt; 4726140, 4726140, 4726140, 4726140, 4726140, 4726140, 472614…
$ Year      &lt;int&gt; 2006, 2006, 2006, 2006, 2006, 2006, 2006, 2006, 2006, 2006, …
$ Month     &lt;int&gt; 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, …
$ Day       &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 1…
$ y8hrmax   &lt;dbl&gt; 53.88, 57.13, 72.00, 36.63, 42.63, 30.88, 38.25, 42.12, 46.5…
$ xmaxtemp  &lt;dbl&gt; 27.85772, 30.11563, 30.00001, 27.89656, 25.65698, 24.61968, …
$ xwdsp     &lt;dbl&gt; 5.459953, 8.211767, 4.459581, 3.692225, 4.374314, 4.178086, …
$ xrh       &lt;dbl&gt; 2.766221, 3.197750, 3.225186, 4.362334, 3.950320, 3.420533, …
$ date      &lt;date&gt; 2006-07-01, 2006-07-02, 2006-07-03, 2006-07-04, 2006-07-05,…</code></pre>
</div>
</div>
<ul>
<li>We now plot the concentrations of ozone for each monitoring station using the package <code>mvtsplot</code>, which allows the visualization of Multivariate time series. To be able to use it, we need to convert the data <strong>from long to wide format</strong>:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>O3 <span class="ot">=</span> nysptime <span class="sc">%&gt;%</span> <span class="fu">select</span>(s.index, y8hrmax, date) <span class="co"># select ozone</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>O3_wide <span class="ot">=</span> O3 <span class="sc">%&gt;%</span> <span class="fu">pivot_wider</span>(<span class="at">names_from=</span>s.index, <span class="at">values_from=</span>y8hrmax)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>O3_wide <span class="ot">=</span> O3_wide[,<span class="sc">-</span><span class="dv">1</span>] <span class="co"># remove date</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>O3_wide <span class="ot">=</span> <span class="fu">data.matrix</span>(O3_wide)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(O3_wide)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(O3_wide) <span class="ot">=</span> <span class="fu">unique</span>(O3[,<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And then plot the daily ozone concentrations for the 28 monitoring stations (Jul 1– Aug 31, 2006) using the package <code>mvtsplot</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Daily ozone levels for 28 monitoring stations, Jul 1– Aug 31, 2006</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mvtsplot</span>(O3_wide, <span class="at">group =</span> <span class="cn">NULL</span>, <span class="at">xtime =</span> <span class="cn">NULL</span>, <span class="at">norm =</span> <span class="fu">c</span>(<span class="st">"global"</span>),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">levels =</span> <span class="dv">3</span>, <span class="at">smooth.df =</span> <span class="cn">NULL</span>, <span class="at">margin =</span> <span class="cn">TRUE</span>, <span class="at">sort =</span><span class="cn">NULL</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">main =</span> <span class="st">""</span>, <span class="at">palette =</span> <span class="st">"PRGn"</span>, <span class="at">rowstat =</span> <span class="st">"median"</span>, xlim,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">bottom.ylim =</span> <span class="cn">NULL</span>, <span class="at">right.xlim=</span><span class="cn">NULL</span>, <span class="at">gcol =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Practical5_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Comment: In the plot we use as color <code>PRGn</code> (default) from the <code>RColorBrewer</code> palettes. Here green indicates high values and purple indicates low values. Missing data are denoted by the color white. The bottom panel shows the overall median. Finally, on the right hand side panel, we can see the boxplots of the data in each time series.</p>
<ul>
<li>Moreover, we can check the basic statistics for ozone concentrations and make the histogram to check the distribution of the data:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nysptime<span class="sc">$</span>y8hrmax)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
  12.38   37.35   46.50   47.82   57.63  107.00      24 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>nysptime <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(y8hrmax), <span class="at">col=</span><span class="st">"orange"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Practical5_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>We can visualize the relationships between the data using <code>ggpairs()</code> in the <code>GGally</code> package :</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggpairs</span>(nysptime[,<span class="dv">9</span><span class="sc">:</span><span class="dv">12</span>]) <span class="co"># print correlations between variables</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Practical5_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>We print the table of the correlations between ozone and the three predictors using the package <code>corrr</code></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>tab_cor <span class="ot">=</span> nysptime <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(y8hrmax, xmaxtemp, xwdsp, xrh) <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">correlate</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">shave</span>(<span class="at">upper =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fashion</span>(<span class="at">decimals =</span> <span class="dv">2</span>, <span class="at">na_print =</span> <span class="st">"—"</span>) </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>tab_cor</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      term y8hrmax xmaxtemp xwdsp xrh
1  y8hrmax       —        —     —   —
2 xmaxtemp     .66        —     —   —
3    xwdsp     .22      .18     —   —
4      xrh    -.39     -.50   .14   —</code></pre>
</div>
</div>
<ul>
<li>Now, we create a variable named <code>time</code> which is an index for time</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>nysptime<span class="sc">$</span>time <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">n_distinct</span>(nysptime<span class="sc">$</span>date),</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">n_distinct</span>(nysptime<span class="sc">$</span>s.index))</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(nysptime) <span class="co">#1736 (28stations*62 days)  14</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1736   14</code></pre>
</div>
</div>
<ul>
<li>We <strong>consider only the first 30 time points</strong> for reducing the computational costs</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>nysptime <span class="ot">=</span> nysptime <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time <span class="sc">&lt;=</span> <span class="dv">30</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(nysptime) <span class="co">#840 (28stations*30 days)  14</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 840  14</code></pre>
</div>
</div>
<ul>
<li>In order to approximately normally distributed data for the response variable, compute the square root transformation of <code>y8hrmax</code> and create a new variable named <code>sqrty8hrmax</code>, then plot the histogram of data as we did before (NOTE: other suitable data transformation could be taking the natural logarithm of ozone concentrations)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>nysptime<span class="sc">$</span>sqrty8hrmax <span class="ot">=</span> <span class="fu">sqrt</span>(nysptime<span class="sc">$</span>y8hrmax)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>nysptime <span class="sc">%&gt;%</span> </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(sqrty8hrmax), <span class="at">col=</span><span class="st">"orange"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Practical5_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>We finally import and explore the grid that will be used for the predictions to obtain a continuous surface of ozone concentrations. To do so, we use the data in the <code>gridnysptime</code> object, which contains a total of 6200 rows for 62 days of observations for 10x10 = 100 grid points.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(gridnysptime)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6200   11</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(gridnysptime)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "data.frame"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gridnysptime)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  s.index Longitude Latitude     utmx    utmy Year Month Day xmaxtemp    xwdsp
1       1       -72     45.2 735621.3 5009547 2006     7   1 25.78623 5.602757
2       1       -72     45.2 735621.3 5009547 2006     7   2 29.35546 7.946272
3       1       -72     45.2 735621.3 5009547 2006     7   3 28.04157 3.891001
4       1       -72     45.2 735621.3 5009547 2006     7   4 26.55014 3.324329
5       1       -72     45.2 735621.3 5009547 2006     7   5 24.65790 5.221672
6       1       -72     45.2 735621.3 5009547 2006     7   6 23.54229 3.235730
       xrh
1 3.311548
2 3.260382
3 2.804062
4 4.459596
5 4.096214
6 3.737357</code></pre>
</div>
</div>
</section>
<section id="spatio-temporal-model" class="level2">
<h2 class="anchored" data-anchor-id="spatio-temporal-model">Spatio-temporal model</h2>
<p>We implement the spatio-temporal model for ozone concentrations as follows.Let</p>
<ul>
<li><p><span class="math inline">\(\boldsymbol{Y}_t =(Y(\mathbf{s}_1,t), \dots, Y(\mathbf{s}_n,t))'\)</span> be the observed data at location <span class="math inline">\(\mathbf{s}\)</span> in day <span class="math inline">\(t\)</span></p></li>
<li><p><span class="math inline">\(\boldsymbol{O}_t =(O(\mathbf{s}_1,t), \dots, O(\mathbf{s}_n,t))'\)</span> be the true value corresponding to <span class="math inline">\(\boldsymbol{Y}_t\)</span>.</p></li>
</ul>
<p>We use a hierarchical structure and we fit the following Bayesian model, with nugget effect model together with an independent Gaussian Process (GP) model at each time point:</p>
<p><span class="math display">\[
\begin{aligned}
  \boldsymbol{Y}_t &amp;= \boldsymbol{O}_t + \boldsymbol{\epsilon}_t \\
  \boldsymbol{O}_t &amp;= \boldsymbol{X}_t \boldsymbol{\beta} + \boldsymbol{\omega}_t
\end{aligned}
\]</span></p>
<p>where:</p>
<ul>
<li><p><span class="math inline">\(\boldsymbol{X}_t\)</span> are the predictor values and <span class="math inline">\(\boldsymbol{\beta}\)</span> are the regression coefficients (i.e.&nbsp;large-scale component)</p></li>
<li><p><span class="math inline">\(\boldsymbol{\omega}_t\)</span> refers to the <strong>latent spatio-temporal process</strong> , which changes in time with first order autoregressive dynamics and spatially correlated innovations as seen in Session 7</p></li>
<li><p><span class="math inline">\(\boldsymbol{\epsilon}_t=(\epsilon(\mathbf{s}_1,t), \dots, \epsilon(\mathbf{s}_n,t))'\)</span> is the nugget effect or the pure error term, independent in space and time.</p></li>
</ul>
<p>The model we are going to implement is a separable model similar to the one described in Cameletti et al 2013 <a href="https://link.springer.com/article/10.1007/s10182-012-0196-3" class="uri">https://link.springer.com/article/10.1007/s10182-012-0196-3</a></p>
<p>Remember that a spatio-temporal model is said to be separable when the space-time covariance structure can be decomposed into a spatial and a temporal term, i.e., the spatio-temporal covariance can be expressed as a Kronecker product of a spatial and a temporal covariance.</p>
</section>
<section id="cross-validation" class="level2">
<h2 class="anchored" data-anchor-id="cross-validation">Cross-validation</h2>
<section id="prediction-at-the-hold-out-validation-sites-k-fold-cross-validation" class="level3">
<h3 class="anchored" data-anchor-id="prediction-at-the-hold-out-validation-sites-k-fold-cross-validation">Prediction at the hold-out validation sites: k-fold cross-validation</h3>
<p>We implement a <strong>k-fold cross-validation</strong> at the sensor level taking <strong>k=5</strong>, that is we split the data in k = 5 groups of sites to obtain 5 training sets and 5 validation (or test) sets.</p>
<p>To make the process reproducible, we will set a seed: <code>set.seed(23)</code></p>
<p>We ensure that all measurements from the same sensor (<code>s.index</code>) belong to the same fold. The fold assignments are then merged back into the main dataset to label each observation with its corresponding fold.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">23</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare fold assignment: we use 's.index' as sesonr ID</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>stations <span class="ot">&lt;-</span> <span class="fu">unique</span>(nysptime<span class="sc">$</span>s.index)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">cut</span>(<span class="fu">seq_along</span>(stations), <span class="at">breaks =</span> <span class="dv">5</span>, <span class="at">labels =</span> <span class="cn">FALSE</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>station_folds <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">s.index =</span> stations,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>                            <span class="at">fold =</span> <span class="fu">sample</span>(folds))</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove previous 'fold' column if it exists</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">"fold"</span> <span class="sc">%in%</span> <span class="fu">names</span>(nysptime)) {</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  nysptime<span class="sc">$</span>fold <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Now merge fold assignment back into main dataset</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>nysptime <span class="ot">&lt;-</span> <span class="fu">merge</span>(nysptime, station_folds, <span class="at">by =</span> <span class="st">"s.index"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we initialize the vectors to store performance metrics: root mean sqyared error (RMSE), mean absolute error (MAE), Bias, the coefficient of correlation between observed and predicted and the squared coefficient of correlation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>rmse_vec <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>mae_vec <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>bias_vec <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>r_vec <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>rsq_vec <span class="ot">&lt;-</span> <span class="fu">c</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>We now start the cross-validation loop</strong>, where we walk through all the steps of an INLA-SPDE analysis. This section is intentionally kept with minimal comments, as each step will be explained in detail later, when we perform prediction over the full grid.</p>
<p>At the end of the loop, we will evaluate model performance using the standard metrics specified, namely RMSE, MAE, bias, and correlation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Start cross-validation loop</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>) {</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Fold"</span>, i, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Split into training and validation sets</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>training.data   <span class="ot">&lt;-</span> nysptime[nysptime<span class="sc">$</span>fold <span class="sc">!=</span> i, ]</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>validation.data <span class="ot">&lt;-</span> nysptime[nysptime<span class="sc">$</span>fold <span class="sc">==</span> i, ]</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>coords_train <span class="ot">=</span> <span class="fu">unique</span>(training.data[<span class="fu">c</span>(<span class="st">"Longitude"</span>, <span class="st">"Latitude"</span>)]) <span class="co"># coordinates for each station</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the mesh</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>boundary <span class="ot">=</span> <span class="fu">inla.nonconvex.hull</span>(<span class="fu">as.matrix</span>(coords_train[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]))</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>mesh <span class="ot">=</span> <span class="fu">inla.mesh.2d</span>(<span class="at">boundary =</span> boundary, <span class="at">max.edge =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">1.3</span>), </span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>                      <span class="at">cutoff =</span> <span class="fl">0.1</span>, <span class="at">offset =</span> <span class="fl">0.5</span>)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Define SPDE model with prior assumptions (PC priors)</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>spde <span class="ot">&lt;-</span> <span class="fu">inla.spde2.pcmatern</span>(<span class="at">mesh =</span> mesh,</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>                              <span class="at">prior.range =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="fl">0.5</span>),   </span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>                              <span class="at">prior.sigma =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.01</span>))   </span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Build index set and projection matrix for training set</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>n_days <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(training.data<span class="sc">$</span>time))</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>n_spatial.cv <span class="ot">=</span> mesh<span class="sc">$</span>n </span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>s_index <span class="ot">=</span> <span class="fu">inla.spde.make.index</span>(</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"spatial.field"</span>,</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">n.spde =</span> n_spatial.cv, <span class="co"># or n.spde = spde$n.spde </span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">n.group =</span> n_days)</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>coordinates.alldays.cv <span class="ot">=</span> training.data[<span class="fu">c</span>(<span class="st">"Longitude"</span>, <span class="st">"Latitude"</span>)] <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>()</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>A_train <span class="ot">=</span> <span class="fu">inla.spde.make.A</span>(<span class="at">mesh =</span> mesh,</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>                        <span class="at">loc =</span> coordinates.alldays.cv,</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>                        <span class="at">group =</span> training.data<span class="sc">$</span>time,</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>                        <span class="at">n.group =</span> n_days)</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Build ithe syack for the estimation part</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>stk_est <span class="ot">=</span> <span class="fu">inla.stack</span>(</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> training.data<span class="sc">$</span>sqrty8hrmax),</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">A =</span> <span class="fu">list</span>(A_train, <span class="dv">1</span>),</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">effects=</span><span class="fu">list</span>(<span class="fu">c</span>(s_index,</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">list</span>(<span class="at">Intercept=</span><span class="dv">1</span>)),</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">list</span>(training.data[,<span class="dv">10</span><span class="sc">:</span><span class="dv">12</span>])),</span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">tag=</span><span class="st">"est"</span>)</span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify coordinates of the validation set</span></span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>coords_valid <span class="ot">=</span>  validation.data[<span class="fu">c</span>(<span class="st">"Longitude"</span>, <span class="st">"Latitude"</span>)]</span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>groupp <span class="ot">=</span> validation.data[, <span class="dv">14</span>]</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Create projection matrix A matrix for prediction locations (validation set)</span></span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>A_valid <span class="ot">=</span> <span class="fu">inla.spde.make.A</span>(</span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">mesh =</span>  mesh,</span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">loc =</span> <span class="fu">as.matrix</span>(coords_valid),</span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> groupp, </span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">n.group =</span> n_days)</span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dim</span>(A_valid)</span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the stack for the prediction locations (validation set) </span></span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>stk_pred <span class="ot">=</span> <span class="fu">inla.stack</span>(</span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> <span class="cn">NA</span>),</span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">A =</span> <span class="fu">list</span>(A_valid, <span class="dv">1</span>),</span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">effects=</span><span class="fu">list</span>(<span class="fu">c</span>(s_index, <span class="co">#Spatial field </span></span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">list</span>(<span class="at">Intercept=</span><span class="dv">1</span>)),</span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">list</span>(validation.data[,<span class="dv">10</span><span class="sc">:</span><span class="dv">12</span>])),</span>
<span id="cb27-69"><a href="#cb27-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">tag=</span><span class="st">"pred"</span>)</span>
<span id="cb27-70"><a href="#cb27-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-71"><a href="#cb27-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Final stack containing the estimation and prediction stacks</span></span>
<span id="cb27-72"><a href="#cb27-72" aria-hidden="true" tabindex="-1"></a>stk <span class="ot">=</span> <span class="fu">inla.stack</span>(stk_est, stk_pred)</span>
<span id="cb27-73"><a href="#cb27-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-74"><a href="#cb27-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Prior for rho parameter</span></span>
<span id="cb27-75"><a href="#cb27-75" aria-hidden="true" tabindex="-1"></a>rho_hyper <span class="ot">=</span> <span class="fu">list</span>(<span class="at">theta =</span> <span class="fu">list</span>(<span class="at">prior =</span> <span class="st">"pccor1"</span>, <span class="at">param =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.9</span>)))</span>
<span id="cb27-76"><a href="#cb27-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-77"><a href="#cb27-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Define model formula</span></span>
<span id="cb27-78"><a href="#cb27-78" aria-hidden="true" tabindex="-1"></a>formula.cv <span class="ot">=</span> y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> Intercept <span class="sc">+</span> xmaxtemp <span class="sc">+</span> xwdsp <span class="sc">+</span> xrh <span class="sc">+</span> </span>
<span id="cb27-79"><a href="#cb27-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f</span>(spatial.field,</span>
<span id="cb27-80"><a href="#cb27-80" aria-hidden="true" tabindex="-1"></a>      <span class="at">model =</span> spde,</span>
<span id="cb27-81"><a href="#cb27-81" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> spatial.field.group,</span>
<span id="cb27-82"><a href="#cb27-82" aria-hidden="true" tabindex="-1"></a>      <span class="at">control.group =</span> <span class="fu">list</span>(<span class="at">model =</span> <span class="st">"ar1"</span>,</span>
<span id="cb27-83"><a href="#cb27-83" aria-hidden="true" tabindex="-1"></a>                           <span class="at">hyper=</span>rho_hyper))</span>
<span id="cb27-84"><a href="#cb27-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-85"><a href="#cb27-85" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb27-86"><a href="#cb27-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Run INLA again for prediction at validation locations </span></span>
<span id="cb27-87"><a href="#cb27-87" aria-hidden="true" tabindex="-1"></a>result_valid <span class="ot">=</span> <span class="fu">inla</span>(</span>
<span id="cb27-88"><a href="#cb27-88" aria-hidden="true" tabindex="-1"></a>    formula.cv,</span>
<span id="cb27-89"><a href="#cb27-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">inla.stack.data</span>(stk, <span class="at">spde =</span> spde),</span>
<span id="cb27-90"><a href="#cb27-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb27-91"><a href="#cb27-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">A =</span> <span class="fu">inla.stack.A</span>(stk), </span>
<span id="cb27-92"><a href="#cb27-92" aria-hidden="true" tabindex="-1"></a>                             <span class="at">compute =</span> <span class="cn">TRUE</span>),</span>
<span id="cb27-93"><a href="#cb27-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">return.marginals.predictor =</span> <span class="cn">TRUE</span>))   </span>
<span id="cb27-94"><a href="#cb27-94" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb27-95"><a href="#cb27-95" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb27-96"><a href="#cb27-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract predicted values at validation locations</span></span>
<span id="cb27-97"><a href="#cb27-97" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">inla.stack.index</span>(stk, <span class="at">tag =</span> <span class="st">"pred"</span>)<span class="sc">$</span>data</span>
<span id="cb27-98"><a href="#cb27-98" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> result_valid<span class="sc">$</span>summary.linear.predictor[idx, <span class="st">"mean"</span>]</span>
<span id="cb27-99"><a href="#cb27-99" aria-hidden="true" tabindex="-1"></a>  obs  <span class="ot">&lt;-</span> validation.data<span class="sc">$</span>sqrty8hrmax</span>
<span id="cb27-100"><a href="#cb27-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-101"><a href="#cb27-101" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the performace metrics</span></span>
<span id="cb27-102"><a href="#cb27-102" aria-hidden="true" tabindex="-1"></a>  rmse_vec[i] <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((obs <span class="sc">-</span> pred)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb27-103"><a href="#cb27-103" aria-hidden="true" tabindex="-1"></a>  mae_vec[i]  <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(obs <span class="sc">-</span> pred), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-104"><a href="#cb27-104" aria-hidden="true" tabindex="-1"></a>  bias_vec[i] <span class="ot">&lt;-</span> <span class="fu">mean</span>(pred <span class="sc">-</span> obs, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-105"><a href="#cb27-105" aria-hidden="true" tabindex="-1"></a>  r_vec[i]    <span class="ot">&lt;-</span> <span class="fu">cor</span>(pred, obs, <span class="at">use =</span> <span class="st">"complete.obs"</span>)</span>
<span id="cb27-106"><a href="#cb27-106" aria-hidden="true" tabindex="-1"></a>  rsq_vec[i]  <span class="ot">&lt;-</span> r_vec[i]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb27-107"><a href="#cb27-107" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fold 1 
Fold 2 
Fold 3 
Fold 4 
Fold 5 </code></pre>
</div>
</div>
<p>Finally we print the performance metrics!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print average performance across folds</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean RMSE:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(rmse_vec), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean RMSE: 0.456 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean MAE:"</span>,  <span class="fu">round</span>(<span class="fu">mean</span>(mae_vec), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean MAE: 0.363 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean Bias:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(bias_vec), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean Bias: -0.031 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean R:"</span>,    <span class="fu">round</span>(<span class="fu">mean</span>(r_vec), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean R: 0.873 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean R²:"</span>,   <span class="fu">round</span>(<span class="fu">mean</span>(rsq_vec), <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean R²: 0.763 </code></pre>
</div>
</div>
</section>
</section>
<section id="exercise" class="level2">
<h2 class="anchored" data-anchor-id="exercise">Exercise</h2>
<p>Repeat the 5-fold cross-validation procedure excluding covariates from the model. Compare the performance metrics (RMSE, MAE, bias, correlation).</p>
<p>Which model performs better: with or without covariates?</p>
</section>
<section id="run-the-model-on-the-entire-data-set-to-obtain-predictions-for-ozone-on-the-grid" class="level2">
<h2 class="anchored" data-anchor-id="run-the-model-on-the-entire-data-set-to-obtain-predictions-for-ozone-on-the-grid">Run the model on the entire data set to obtain predictions for ozone on the grid</h2>
<p>We now repeat all the same process to implement the full model, but using the entire data set, i.e.&nbsp;<code>nysptime</code> and obtaining daily predictions of ozone on the entire domain.</p>
<ul>
<li><strong>Create the mesh and the SPDE model</strong></li>
</ul>
<p>Now we create a triangulation of our domain. First we establish the boundary of the domain with the function <code>inla.nonconvex.hull</code>, then we create the mesh with <code>inla.mesh.2d</code> function, as we did before, but using all the data from the New York stations (i.e.&nbsp;<code>nysptime</code>). Create the new mesh as we did before, and call it as <code>mesh</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">=</span> <span class="fu">unique</span>(nysptime[<span class="fu">c</span>(<span class="st">"Longitude"</span>, <span class="st">"Latitude"</span>)]) <span class="co"># coordinates for each station</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>boundary <span class="ot">=</span> <span class="fu">inla.nonconvex.hull</span>(<span class="fu">as.matrix</span>(coords[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]))</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>mesh <span class="ot">=</span> <span class="fu">inla.mesh.2d</span>(<span class="at">boundary =</span> boundary, <span class="at">max.edge =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">1.5</span>), <span class="at">cutoff =</span> <span class="fl">0.1</span>, <span class="at">offset =</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now plot the mesh with the 28 station points. To do so, we use the <code>gg()</code> function from the <code>inlabru</code> package</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gg</span>(mesh) <span class="sc">+</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> coords, <span class="fu">aes</span>(Longitude, Latitude)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Practical5_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Given the mesh, it is now possible to create the SPDE model using the <code>inla.spde2.matern</code> function or <code>inla.spde2.pcmatern.</code> Here we use PC priors</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>spde <span class="ot">=</span> <span class="fu">inla.spde2.pcmatern</span>(<span class="at">mesh =</span> mesh, <span class="at">alpha =</span> <span class="dv">2</span>, </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">prior.range =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.01</span>),   <span class="co"># p(range &lt; 1) = 0.01</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">prior.sigma =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="fl">0.01</span>)) <span class="co"># p(sigma &gt; 2) = 0.01</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>spde<span class="sc">$</span>n.spde <span class="co">#n. of mesh vertices</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 240</code></pre>
</div>
</div>
<ul>
<li><strong>Create the index set</strong></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>n_days <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(nysptime<span class="sc">$</span>time))</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>n_spatial <span class="ot">=</span> mesh<span class="sc">$</span>n </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>s_index <span class="ot">=</span> <span class="fu">inla.spde.make.index</span>(</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="st">"spatial.field"</span>,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.spde =</span> n_spatial, <span class="co"># or n.spde = spde$n.spde </span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.group =</span> n_days)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>s_index</code> contains two important items:</p>
<p>(i) the <code>spatial.field</code> index, which runs from 1 to <code>n_spatial</code> for <code>n_days</code> times,</p>
<p>(ii) the <code>spatial.field.group</code>, which runs from 1 to <code>n_days</code>, with each element replicated <code>n_spatial</code> times.</p>
<ul>
<li><strong>Create the Projection Matrix</strong></li>
</ul>
<p>Create the projection matrix using the function <code>inla.spde.make.A</code> function. Remember that this function takes as arguments the mesh, the measurement locations <code>loc</code>, the measurement group (here day), the number of groups. Call the projector matrix for the estimation <code>A_est</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>coordinates.alldays <span class="ot">=</span> nysptime[<span class="fu">c</span>(<span class="st">"Longitude"</span>, <span class="st">"Latitude"</span>)] <span class="sc">%&gt;%</span> <span class="fu">as.matrix</span>()</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>A_est <span class="ot">=</span> <span class="fu">inla.spde.make.A</span>(<span class="at">mesh =</span> mesh,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">loc =</span> coordinates.alldays,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">group =</span> nysptime<span class="sc">$</span>time,</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">n.group =</span> n_days)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, check the dimension of the projector matrix</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(A_est) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  840 7200</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(nysptime) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 840</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(s_index<span class="sc">$</span>spatial.field) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7200</code></pre>
</div>
</div>
<p>We see that the matrix A is equal in dimension to <code>number of observations</code> x <code>number of indices</code> of our basis functions in space and time.</p>
<ul>
<li><strong>Define the Stacks for estimation and prediction</strong></li>
</ul>
<p>First, we define the stack for the estimation part. Call it <code>stack_est</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>stack_est <span class="ot">=</span> <span class="fu">inla.stack</span>(</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> nysptime<span class="sc">$</span>sqrty8hrmax),</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">A =</span> <span class="fu">list</span>(A_est, <span class="dv">1</span>),</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">effects=</span><span class="fu">list</span>(<span class="fu">c</span>(s_index,</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">Intercept=</span><span class="dv">1</span>)),</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(nysptime[,<span class="dv">10</span><span class="sc">:</span><span class="dv">12</span>])),</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">tag=</span><span class="st">"est"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we need to define the stack for the prediction part, but first we displays the grid points together with the mesh:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>gridnysptime <span class="sc">%&gt;%</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(Longitude, Latitude) <span class="sc">%&gt;%</span> </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(Longitude, Latitude)) <span class="sc">+</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gg</span>(mesh)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Practical5_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Then, we create also for <code>gridnysptime</code> the variable containing the date information and then a variable which is an index for time:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>gridnysptime <span class="ot">=</span> gridnysptime <span class="sc">%&gt;%</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">make_date</span>(Year, Month, Day))</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>gridnysptime<span class="sc">$</span>time <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">n_distinct</span>(gridnysptime<span class="sc">$</span>date),</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">n_distinct</span>(gridnysptime<span class="sc">$</span>s.index))</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(gridnysptime)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 6,200
Columns: 13
$ s.index   &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ Longitude &lt;dbl&gt; -72, -72, -72, -72, -72, -72, -72, -72, -72, -72, -72, -72, …
$ Latitude  &lt;dbl&gt; 45.2, 45.2, 45.2, 45.2, 45.2, 45.2, 45.2, 45.2, 45.2, 45.2, …
$ utmx      &lt;dbl&gt; 735621.3, 735621.3, 735621.3, 735621.3, 735621.3, 735621.3, …
$ utmy      &lt;dbl&gt; 5009547, 5009547, 5009547, 5009547, 5009547, 5009547, 500954…
$ Year      &lt;int&gt; 2006, 2006, 2006, 2006, 2006, 2006, 2006, 2006, 2006, 2006, …
$ Month     &lt;int&gt; 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, …
$ Day       &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 1…
$ xmaxtemp  &lt;dbl&gt; 25.78623, 29.35546, 28.04157, 26.55014, 24.65790, 23.54229, …
$ xwdsp     &lt;dbl&gt; 5.6027574, 7.9462719, 3.8910009, 3.3243287, 5.2216721, 3.235…
$ xrh       &lt;dbl&gt; 3.311548, 3.260382, 2.804062, 4.459596, 4.096214, 3.737357, …
$ date      &lt;date&gt; 2006-07-01, 2006-07-02, 2006-07-03, 2006-07-04, 2006-07-05,…
$ time      &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 1…</code></pre>
</div>
</div>
<p><strong>For the sake of simplicity we consider here only the first time point</strong>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>gridnysptime <span class="ot">=</span> gridnysptime <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time <span class="sc">==</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We construct a stack containing the matrices and vector defining the model at the prediction locations. To do so, we construct the matrix <code>A_pred</code> that projects the GMRF from the prediction locations to the mesh nodes. We specify the prediction locations as <code>coords_grid</code>. We will make predictions at day 1:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>coords_grid <span class="ot">=</span> gridnysptime[<span class="fu">c</span>(<span class="st">"Longitude"</span>, <span class="st">"Latitude"</span>)]</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co"># define prediction day</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>i_day <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>which_date <span class="ot">=</span> <span class="fu">unique</span>(nysptime<span class="sc">$</span>date)[i_day]</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"* You will get a prediction for "</span>, which_date, <span class="st">"*"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "* You will get a prediction for  2006-07-01 *"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create A matrix for grid prediction </span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>A_pred <span class="ot">=</span> <span class="fu">inla.spde.make.A</span>(</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mesh =</span>  mesh,</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">loc =</span> <span class="fu">as.matrix</span>(coords_grid),</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> i_day,</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">n.group =</span> n_days)</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(A_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  100 7200</code></pre>
</div>
</div>
<p>Finally, we create the <strong>stack for the predictions</strong> and the <strong>joint stack</strong>. Call the stack for the predictions as <code>stack_pred</code> and the full stack as <code>stack</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># stack for prediction part</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>stack_pred <span class="ot">=</span> <span class="fu">inla.stack</span>(</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> <span class="cn">NA</span>),</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">A =</span> <span class="fu">list</span>(A_pred, <span class="dv">1</span>),</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">effects=</span><span class="fu">list</span>(<span class="fu">c</span>(s_index, <span class="co">#Spatial field </span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>          <span class="fu">list</span>(<span class="at">Intercept=</span><span class="dv">1</span>)),</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>          <span class="fu">list</span>(gridnysptime[,<span class="dv">9</span><span class="sc">:</span><span class="dv">11</span>])),</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">tag=</span><span class="st">"pred"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Final stack containing the estimation and prediction stacks</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>stack <span class="ot">=</span> <span class="fu">inla.stack</span>(stack_est, stack_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><strong>Run INLA</strong></li>
</ul>
<p>Now, we are ready to fit complete the model. We specify a PC prior on the AR(1) coefficient $\rho$, such that <span class="math inline">\(p(\rho&gt;0=0.9)\)</span> as we did for the cross-validation task</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># prior for AR(1) coefficient</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>rho_hyper <span class="ot">=</span> <span class="fu">list</span>(<span class="at">theta =</span> <span class="fu">list</span>(<span class="at">prior =</span> <span class="st">"pccor1"</span>, <span class="at">param =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.9</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define the formula, including the intercept, 3 linear effects of the meteorological covariates and the spatio-temporal field (with AR(1) temporal dynamics):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># formula</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">=</span> y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> Intercept <span class="sc">+</span> xmaxtemp <span class="sc">+</span> xwdsp <span class="sc">+</span> xrh <span class="sc">+</span> </span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">f</span>(spatial.field,</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">model =</span> spde,</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> spatial.field.group,</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">control.group =</span> <span class="fu">list</span>(<span class="at">model =</span> <span class="st">"ar1"</span>,</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">hyper=</span>rho_hyper))</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="co"># fit the model</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">=</span> <span class="fu">inla</span>(</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>  formula,</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">inla.stack.data</span>(stack, <span class="at">spde =</span> spde),</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">A =</span> <span class="fu">inla.stack.A</span>(stack), </span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>                           <span class="at">compute =</span> <span class="cn">TRUE</span>),</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">return.marginals.predictor =</span> <span class="cn">TRUE</span>))   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="results" class="level3">
<h3 class="anchored" data-anchor-id="results">Results</h3>
<ul>
<li>First we check a summary of the results</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time used:
    Pre = 0.407, Running = 34.8, Post = 17.1, Total = 52.4 
Fixed effects:
            mean    sd 0.025quant 0.5quant 0.975quant   mode kld
Intercept  1.001 1.319     -1.573    0.995      3.611  0.995   0
xmaxtemp   0.223 0.036      0.151    0.223      0.294  0.223   0
xwdsp      0.053 0.032     -0.010    0.053      0.116  0.053   0
xrh       -0.078 0.107     -0.288   -0.078      0.132 -0.078   0

Random effects:
  Name    Model
    spatial.field SPDE2 model

Model hyperparameters:
                                          mean    sd 0.025quant 0.5quant
Precision for the Gaussian observations 12.825 1.231     10.575   12.766
Range for spatial.field                  2.915 0.351      2.295    2.890
Stdev for spatial.field                  0.966 0.109      0.777    0.957
GroupRho for spatial.field               0.799 0.048      0.695    0.803
                                        0.975quant   mode
Precision for the Gaussian observations     15.417 12.646
Range for spatial.field                      3.676  2.835
Stdev for spatial.field                      1.205  0.935
GroupRho for spatial.field                   0.883  0.809

Marginal log-Likelihood:  -608.42 
 is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
<ul>
<li>Wecan explore the output names as follows</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(fit<span class="sc">$</span>marginals.fixed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Intercept" "xmaxtemp"  "xwdsp"     "xrh"      </code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(fit<span class="sc">$</span>marginals.random)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "spatial.field"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(fit<span class="sc">$</span>marginals.hyperpar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Precision for the Gaussian observations"
[2] "Range for spatial.field"                
[3] "Stdev for spatial.field"                
[4] "GroupRho for spatial.field"             </code></pre>
</div>
</div>
<ul>
<li>Extract the posterior summaries (mean and 95% credible intervals) for the fixed effects only and comment the results</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fixed effects</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(fit<span class="sc">$</span>summary.fixed[,<span class="fu">c</span>(<span class="st">"mean"</span>,<span class="st">"0.025quant"</span>,<span class="st">"0.975quant"</span>)],<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            mean 0.025quant 0.975quant
Intercept  1.001     -1.573      3.611
xmaxtemp   0.223      0.151      0.294
xwdsp      0.053     -0.010      0.116
xrh       -0.078     -0.288      0.132</code></pre>
</div>
</div>
<p>Comment:</p>
<p>Using a subset of the New York data (only first 30 days are included), we see that the parameter estimates show that the max temperature has an impact on ozone concentrations, since the 95% credible intervals of the regression coefficients doesn’t contain zero.</p>
<ul>
<li>Now we plot the posterior densities for the fixed effects</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>modfix <span class="ot">=</span> fit<span class="sc">$</span>summary.fixed</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>modfix</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 mean         sd  0.025quant    0.5quant 0.975quant        mode
Intercept  1.00116051 1.31873540 -1.57253452  0.99485642  3.6110997  0.99496469
xmaxtemp   0.22281345 0.03645619  0.15059430  0.22302163  0.2938407  0.22301966
xwdsp      0.05329022 0.03192028 -0.00977121  0.05342221  0.1156041  0.05342317
xrh       -0.07785969 0.10684724 -0.28758460 -0.07792685  0.1322323 -0.07793098
                   kld
Intercept 1.413764e-08
xmaxtemp  1.352616e-08
xwdsp     7.931920e-09
xrh       6.456615e-09</code></pre>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mgp=</span><span class="fu">c</span>(<span class="fl">2.2</span>,<span class="fl">0.45</span>,<span class="dv">0</span>), <span class="at">tcl=</span><span class="sc">-</span><span class="fl">0.4</span>, <span class="at">mar=</span><span class="fu">c</span>(<span class="fl">3.3</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit<span class="sc">$</span>marginals.fix[[<span class="dv">1</span>]],<span class="at">type =</span><span class="st">'l'</span>,<span class="at">xlab=</span><span class="fu">expression</span>(beta[<span class="dv">0</span>]),<span class="at">ylab=</span><span class="st">"density"</span>)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> modfix[<span class="dv">1</span>, <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span>)], <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit<span class="sc">$</span>marginals.fix[[<span class="dv">2</span>]],<span class="at">type =</span><span class="st">'l'</span>,<span class="at">xlab=</span><span class="fu">expression</span>(beta[max.temp]),<span class="at">ylab=</span><span class="st">"density"</span>)</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> modfix[<span class="dv">2</span>, <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span>)], <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit<span class="sc">$</span>marginals.fix[[<span class="dv">3</span>]],<span class="at">type =</span><span class="st">'l'</span>,<span class="at">xlab=</span><span class="fu">expression</span>(beta[w.speed]),<span class="at">ylab=</span><span class="st">"density"</span>)</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> modfix[<span class="dv">3</span>, <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span>)], <span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit<span class="sc">$</span>marginals.fix[[<span class="dv">4</span>]],<span class="at">type =</span><span class="st">'l'</span>,<span class="at">xlab=</span><span class="fu">expression</span>(beta[rh]),<span class="at">ylab=</span><span class="st">"density"</span>)</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> modfix[<span class="dv">4</span>, <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span>)], <span class="at">lty=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Practical5_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>Now we check the posterior estimates of the hyperparameters. Obtain their posterior summaries, and call the object as <code>modhy</code></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Hyperparameters </span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>modhy <span class="ot">=</span> fit<span class="sc">$</span>summary.hyperpar</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>modhy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                              mean         sd 0.025quant
Precision for the Gaussian observations 12.8248846 1.23089087 10.5749026
Range for spatial.field                  2.9146406 0.35108202  2.2952407
Stdev for spatial.field                  0.9659951 0.10873459  0.7774822
GroupRho for spatial.field               0.7992096 0.04808633  0.6948142
                                          0.5quant 0.975quant       mode
Precision for the Gaussian observations 12.7655072 15.4167419 12.6463022
Range for spatial.field                  2.8901974  3.6756229  2.8351177
Stdev for spatial.field                  0.9573966  1.2048430  0.9351710
GroupRho for spatial.field               0.8029473  0.8826979  0.8086205</code></pre>
</div>
</div>
<ul>
<li>We extract field, parameter values and distributions for the spatial field using the <code>inla.spde2.result</code> function. Here, the <code>do.tranf = TRUE</code> makes sure that marginals are calculated in the same scale as the data</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>output.field <span class="ot">=</span> <span class="fu">inla.spde2.result</span>(<span class="at">inla =</span> fit,</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">name =</span> <span class="st">"spatial.field"</span>,</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">spde =</span> spde,</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">do.transf =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>We plot the posterior estimates for the parameter of the AR(1) model (coefficient $\rho$), the range that provides the distance value (in the unit of the point coordinates) above which spatial dependencies become negligible and the variance</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>out.range <span class="ot">=</span> <span class="fu">exp</span>(output.field<span class="sc">$</span>summary.log.range.nominal)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>out.var <span class="ot">=</span> <span class="fu">exp</span>(output.field<span class="sc">$</span>summary.log.variance.nominal)</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mgp=</span><span class="fu">c</span>(<span class="fl">2.2</span>,<span class="fl">0.45</span>,<span class="dv">0</span>), <span class="at">tcl=</span><span class="sc">-</span><span class="fl">0.4</span>, <span class="at">mar=</span><span class="fu">c</span>(<span class="fl">3.3</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="co"># AR1 parameter    </span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit<span class="sc">$</span>marginals.hyperpar<span class="sc">$</span><span class="st">`</span><span class="at">GroupRho for spatial.field</span><span class="st">`</span>,<span class="at">type =</span> <span class="st">'l'</span>,<span class="at">xlab =</span> <span class="fu">expression</span>(rho),<span class="at">ylab =</span> <span class="st">"density"</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="fl">0.6</span>,<span class="dv">1</span>))</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a><span class="co"># range</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(output.field<span class="sc">$</span>marginals.variance.nominal[[<span class="dv">1</span>]],<span class="at">type =</span> <span class="st">'l'</span>,<span class="at">xlab =</span> <span class="fu">expression</span>(sigma<span class="sc">^</span><span class="dv">2</span>),<span class="at">ylab =</span> <span class="st">"density"</span>)</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a><span class="co"># variance</span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(output.field<span class="sc">$</span>marginals.range.nominal[[<span class="dv">1</span>]],<span class="at">type =</span> <span class="st">'l'</span>,<span class="at">xlab =</span> <span class="st">"spatial range"</span>,<span class="at">ylab =</span> <span class="st">"density"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Practical5_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>We check the correlation between the data response and the posterior mean of the predicted values</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># index for the random field at the data locations:</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>idat <span class="ot">=</span> <span class="fu">inla.stack.index</span>(stack_est, <span class="st">'est'</span>)<span class="sc">$</span>data</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="co"># correlation between the data response and the posterior mean of the predicted values </span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(nysptime<span class="sc">$</span>sqrty8hrmax, fit<span class="sc">$</span>summary.linear.predictor<span class="sc">$</span>mean[idat], <span class="at">use=</span><span class="st">"complete.obs"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9747155</code></pre>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nysptime<span class="sc">$</span>sqrty8hrmax, fit<span class="sc">$</span>summary.linear.predictor<span class="sc">$</span>mean[idat])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Practical5_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li><strong>Map of the predictions at grid level</strong></li>
</ul>
<p>We now extract the indices to the prediction nodes and then extract the posterior mean of the response at day 1. To do so, we use <code>inla.stack.index()</code> function to get the indices of stack that correspond to <code>tag = "pred"</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the posterior mean values</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>index.pred <span class="ot">=</span> <span class="fu">inla.stack.index</span>(stack, <span class="st">"pred"</span>)<span class="sc">$</span>data</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>post.mean.pred <span class="ot">=</span> fit<span class="sc">$</span>summary.linear.predictor[index.pred,<span class="st">"mean"</span>]</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>post.sd.pred <span class="ot">=</span> fit<span class="sc">$</span>summary.linear.predictor[index.pred,<span class="st">"sd"</span>]</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a><span class="co"># prepare posteriors for mapping  </span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>post.mean.df <span class="ot">=</span> <span class="fu">SpatialPixelsDataFrame</span>(<span class="fu">SpatialPoints</span>(coords_grid),</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a><span class="at">data =</span> <span class="fu">data.frame</span>(post.mean.pred))</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>postsd.df <span class="ot">=</span> <span class="fu">SpatialPixelsDataFrame</span>(<span class="fu">SpatialPoints</span>(coords_grid),</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a><span class="at">data =</span> <span class="fu">data.frame</span>(post.sd.pred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally we present the map of the ozone concentration posterior mean (on the square root scale) and of the prediction standard deviation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior mean</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gg</span>(post.mean.df, <span class="fu">aes</span>(Longitude, Latitude, <span class="at">fill =</span> post.mean.pred))  <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Posterior mean at 2006-07-01"</span>) <span class="sc">+</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a> <span class="co"># scale_fill_viridis() +</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()<span class="sc">+</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> coords, <span class="fu">aes</span>(Longitude, Latitude)) <span class="sc">+</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">low =</span> <span class="st">"blue"</span>, <span class="at">high =</span> <span class="st">"orange"</span>) <span class="sc">+</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Practical5_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior standard deviation</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gg</span>(post.mean.df, <span class="fu">aes</span>(Longitude, Latitude, <span class="at">fill =</span> post.sd.pred))  <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Posterior SD at 2006-07-01"</span>) <span class="sc">+</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="co">#scale_fill_viridis() +</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()<span class="sc">+</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> coords, <span class="fu">aes</span>(Longitude, Latitude)) <span class="sc">+</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">low =</span> <span class="st">"blue"</span>, <span class="at">high =</span> <span class="st">"orange"</span>) <span class="sc">+</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Practical5_files/figure-html/unnamed-chunk-43-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>